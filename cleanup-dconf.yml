---
- hosts: localhost
  connection: local
  become: true

  tasks:
    - name: Remove system dconf database file
      file:
        path: /etc/dconf/db/local.d/00-desktop-settings
        state: absent

    - name: Remove system dconf profile
      file:
        path: /etc/dconf/profile/user
        state: absent

    - name: Remove system dconf database directory (if empty)
      file:
        path: /etc/dconf/db/local.d
        state: absent
      ignore_errors: yes

    - name: Remove system dconf profile directory (if empty)
      file:
        path: /etc/dconf/profile
        state: absent
      ignore_errors: yes

    - name: Update dconf database to apply removal
      command: dconf update

    - name: Reset user dconf settings that were applied system-wide
      shell: |
        # Reset all the keys that were set in the system profile
        dconf reset /org/nemo/desktop/computer-icon-visible
        dconf reset /org/nemo/desktop/home-icon-visible
        dconf reset /org/nemo/desktop/network-icon-visible
        dconf reset /org/nemo/desktop/trash-icon-visible
        dconf reset /org/nemo/desktop/volumes-visible
        dconf reset /org/nemo/preferences/default-folder-viewer
        dconf reset /org/nemo/preferences/default-view
        dconf reset /org/nemo/preferences/default-sort-order
        dconf reset /org/nemo/preferences/default-sort-in-reverse
        dconf reset /org/nemo/list-view/default-zoom-level
        dconf reset /org/x/editor/preferences/editor/scheme
        dconf reset /org/cinnamon/desktop/keybindings/media-keys/shutdown
        dconf reset /org/cinnamon/desktop/keybindings/media-keys/logout
        dconf reset /org/cinnamon/desktop/keybindings/media-keys/terminal
        dconf reset /org/cinnamon/desktop/keybindings/media-keys/www
        dconf reset /org/cinnamon/desktop/keybindings/media-keys/screensaver
        dconf reset /org/cinnamon/desktop/keybindings/media-keys/video-rotation-lock
        dconf reset /org/cinnamon/desktop/keybindings/looking-glass-keybinding
        dconf reset /org/cinnamon/desktop/keybindings/custom-list
        dconf reset -f /org/cinnamon/desktop/keybindings/custom-keybindings/
      become: false
      become_user: "{{ gui_user }}"
      ignore_errors: yes

    - name: Clear Nemo caches and metadata (as user)
      shell: |
        pkill -f nemo || true
        sleep 1
        rm -f /home/{{ gui_user }}/.config/nemo/desktop-metadata || true
        rm -rf /home/{{ gui_user }}/.local/share/gvfs-metadata || true
        rm -rf /home/{{ gui_user }}/.cache/nemo || true
      become: false
      become_user: "{{ gui_user }}"
      ignore_errors: yes
