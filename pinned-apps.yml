---
- name: Configure Cinnamon grouped-window-list settings
  become: no
  gather_facts: yes  # Needed for ansible_date_time and ansible_env
  
  vars:
    # Default pinned apps - override in group_vars/host_vars as needed
    cinnamon_pinned_apps:
      - "firefox.desktop"
      - "org.keepassxc.KeePassXC.desktop"
      - "md.obsidian.Obsidian.desktop:flatpak"
      - "com.unicornsonlsd.finamp.desktop:flatpak"
    
    # Optional: customize other settings if needed
    # cinnamon_show_thumbnails: true
    # cinnamon_title_display: 1
    # cinnamon_thumbnail_size: 6
    
  tasks:
    - name: Ensure Cinnamon spice config directory exists
      file:
        path: "{{ ansible_env.HOME }}/.config/cinnamon/spices/grouped-window-list@cinnamon.org"
        state: directory
        mode: '0755'
    
    - name: Configure Cinnamon grouped-window-list settings
      template:
        src: templates/grouped-window-list.json.j2
        dest: "{{ ansible_env.HOME }}/.config/cinnamon/spices/grouped-window-list@cinnamon.org/2.json"
        backup: yes
        mode: '0644'
      notify: restart cinnamon
      
  handlers:
    - name: restart cinnamon
      shell: |
        # Kill existing cinnamon process gracefully
        if pgrep -x "cinnamon" > /dev/null; then
          nohup bash -c 'sleep 2 && cinnamon --replace' > /dev/null 2>&1 &
        fi
      async: 10
      poll: 0
